package ModelThread;
use strict;
use warnings;
use utf8;
use File::Basename();

chdir(  File::Basename::dirname( $0 )  );
require Logger;
require MPDCtrl;
require PMPCConfig;
require Control;
require Search;
require Preview;
require Playlist;
require LightningServer;


my $m_pobjControl;
my $m_pobjSearch;
my $m_pobjPreview;
my $m_pobjPlaylist;
my $m_pobjLightningServer;




########################################################################################################################
sub init
########################################################################################################################
{
	my ($pobjConfig) = @_;
	
	
	Logger->GetInstance()->Write( undef, 2, "Player is starting ...");
	
	MPDCtrl->GetInstance()->SetMPDDevice( $pobjConfig->GetMPDDevice() );
	
	$m_pobjControl = Control->new();
	$m_pobjSearch = Search->new($pobjConfig);
	$m_pobjPreview = Preview->new($pobjConfig);
	$m_pobjPlaylist = Playlist->new($pobjConfig);
	$m_pobjLightningServer = LightningServer->new($pobjConfig);
	
	
	return $m_pobjPlaylist->haveChartsToBeReloaded();
}


########################################################################################################################
sub finit
########################################################################################################################
{
	my ($nExitCode) = @_;
	
	$m_pobjLightningServer->delete();
	undef $m_pobjLightningServer;
	$m_pobjPlaylist->delete();
	undef $m_pobjPlaylist;
	undef $m_pobjPreview;
	undef $m_pobjSearch;
	undef $m_pobjControl;
	
	Logger->GetInstance()->Write( undef, 2, "Set exit code to $nExitCode");
#	$SIG{'TERM'} = sub { 
#		Logger->GetInstance()->Write( undef, 2, "Exiting with exit code $nExitCode");
#		exit($nExitCode);
#	};
}

########################################################################################################################
sub update
########################################################################################################################
{
	MPDCtrl->GetInstance()->Update();
	my $fUpdatePlaylist = $m_pobjPlaylist->Update();
	
	return $fUpdatePlaylist;
}

########################################################################################################################
sub getInfo
########################################################################################################################
{
	return $m_pobjControl->getInfo();
}

########################################################################################################################
sub playOrPause
########################################################################################################################
{
	$m_pobjControl->PlayOrPause();
}

########################################################################################################################
sub next
########################################################################################################################
{
	$m_pobjControl->Next();
}

########################################################################################################################
sub playlistAdd
########################################################################################################################
{
	my ($szSong) = @_;
	
	return $m_pobjPlaylist->Add($szSong);
}

########################################################################################################################
sub playlistMove
########################################################################################################################
{
	my ($nPos) = @_;
	
	$m_pobjPlaylist->Move($nPos);
}

########################################################################################################################
sub playlistGet
########################################################################################################################
{
	return $m_pobjPlaylist->get();
}

########################################################################################################################
sub searchSongs
########################################################################################################################
{
	my ($szSearchString) = @_;
	
	my $pobjList = $m_pobjSearch->Search( $szSearchString );
	
	return $pobjList; 
}

########################################################################################################################
sub downloadSong
########################################################################################################################
{
	my ($szSong, $nID) = @_;
	
	$m_pobjSearch->downloadSong( $szSong, $nID );
}

########################################################################################################################
sub previewGetDevices
########################################################################################################################
{
	return $m_pobjPreview->GetDeviceList();
}

########################################################################################################################
sub previewPlay
########################################################################################################################
{
	my ($szSong) = @_;
	
	return $m_pobjPreview->play( $szSong );
}

########################################################################################################################
sub previewGetPosition
########################################################################################################################
{
	return $m_pobjPreview->getPosition();
}

########################################################################################################################
sub previewChangePosition
########################################################################################################################
{
	my ($nNewPosTime) = @_;
	
	$m_pobjPreview->changePosition( $nNewPosTime );
}

########################################################################################################################
sub lightningSendButtonStats
########################################################################################################################
{
	my (@afState) = @_;
	
	$m_pobjLightningServer->SendButtonStats(@afState);
}

########################################################################################################################
sub chartsGet
########################################################################################################################
{
	my ($szChartsName) = @_;
	
	return $m_pobjPlaylist->getCharts($szChartsName);
}

########################################################################################################################
sub refresh
########################################################################################################################
{
	my ($fDownloadChartsIfNotAvailable) = @_;
	
	
	MPDCtrl->GetInstance()->updateDatabase();
	$m_pobjPlaylist->loadCharts($fDownloadChartsIfNotAvailable);
}

########################################################################################################################
sub favoriteGetFiles
########################################################################################################################
{
	return $m_pobjPlaylist->getFavoriteFiles();
}

########################################################################################################################
sub favoriteAdd
########################################################################################################################
{
	my ($szSong) = @_;
	
	return $m_pobjPlaylist->addFavorite($szSong);
}

########################################################################################################################
sub favoriteRemove
########################################################################################################################
{
	my ($szSong) = @_;
	
	return $m_pobjPlaylist->removeFavorite($szSong);
}

########################################################################################################################
sub favoriteGet
########################################################################################################################
{
	return $m_pobjPlaylist->getFavorite();
}

########################################################################################################################
sub getMPDDevices
########################################################################################################################
{
	return MPDCtrl->GetInstance()->GetMPDDevices();
}
1;
